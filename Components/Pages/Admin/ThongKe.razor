@page "/admin/thongke"
@using BlazorStoreManagementWebApp.Components.Forms.Admin
@attribute [StreamRendering]
@rendermode InteractiveServer
@using Components.Layout.Admin;
@layout MainLayout

<!-- Page Title -->
<div class="content-header">
    <h2>
        <i class="fas fa-chart-pie"></i>
        Thống kê doanh thu
    </h2>
</div>
<div class="dashboard-wrapper" style="display:flex; gap:1rem; flex-wrap:wrap;">

    <!-- Cột trái: Đơn hàng hôm nay -->
    <div class="orders-section-column" style="flex:1 1 300px; min-width:300px; height: 100%;">
        <div class="orders-section">
            <h3 class="orders-title">
                <i class="bi bi-receipt me-2"></i> Đơn hàng hôm nay
            </h3>

            <div class="orders-list">
                @if (TodayOrderList == null || TodayOrderList.Count == 0)
                {
                    <div class="order-item d-flex flex-column align-items-center justify-content-center" style="height: 100%; box-shadow: none; background: transparent;">
                        <i class="bi bi-inbox" style="font-size: 2rem; color: #cbd5e1;"></i>
                        <span style="color:#6b7280; font-size: 0.9rem; margin-top: 8px;">Hôm nay chưa có đơn hàng</span>
                    </div>
                }
                else
                {
                    @foreach (var order in TodayOrderList)
                    {
                        // 1. XỬ LÝ TÊN KHÁCH HÀNG
                        // Nếu null hoặc rỗng thì gán là "Khách vãng lai"
                        var customerName = string.IsNullOrEmpty(order.CustomerName) ? "Khách vãng lai" : order.CustomerName;

                        // 2. XỬ LÝ TRẠNG THÁI (Dịch sang Tiếng Việt)
                        // Lấy status gốc chữ thường để dùng cho logic
                        var statusRaw = order.Status?.ToLower() ?? "";
                        var statusVi = "";

                        switch (statusRaw)
                        {
                            case "paid":
                                statusVi = "Đã thanh toán";
                                break;
                            case "pending":
                                statusVi = "Chờ xử lý";
                                break;
                            case "shipping":
                                statusVi = "Đang giao";
                                break;
                            case "cancelled":
                                statusVi = "Đã hủy";
                                break;
                            case "failed":
                                statusVi = "Thất bại";
                                break;
                            default:
                                statusVi = order.Status; // Nếu không khớp case nào thì hiện nguyên gốc
                                break;
                        }

                        <div class="order-item">
                            <div class="order-header">
                                <span class="order-id">#@order.OrderId</span>
                                <span class="order-amount">
                                    @(order.TotalAmount?.ToString("N0")) ₫
                                </span>
                            </div>

                            <div class="order-details">
                                <div class="d-flex flex-column">
                                    <span title="@customerName" style="font-size: 0.9rem; font-weight: 500;">
                                        <i class="bi bi-person text-muted me-1"></i> @customerName
                                    </span>
                                    <span style="font-size: 0.75rem; color: #9ca3af; margin-top:2px;">
                                        @order.OrderDate?.ToString("HH:mm")
                                    </span>
                                </div>

                                <span class="status-badge status-@statusRaw">
                                    @statusVi
                                </span>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <!-- Cột phải: Filter + KPI + Biểu đồ -->
    <div class="stats-column" style="flex:2 1 600px; min-width:400px; display:flex; flex-direction:column; gap:1rem;">

        <!-- Filter section -->
        <div class="filter-section" style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
            <div class="filter-group">
                <label>Chọn chế độ</label>
                <select @onchange="OnModeChanged" class="form-control">
                    <option selected value="Month">Tháng</option>
                    <option value="Year">Năm</option>
                </select>
            </div>
            @if (SelectedMode == "Month")
            {
                <div class="filter-group">
                    <label>Tháng</label>
                    <select @bind="SelectedMonth" class="form-control">
                        @foreach (var m in Months)
                        {
                            <option value="@m">@m</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label>Năm</label>
                    <select @bind="SelectedYear" class="form-control">
                        @foreach (var y in Years)
                        {
                            <option value="@y">@y</option>
                        }
                    </select>
                </div>
            }
            else if (SelectedMode == "Year")
            {
                <div class="filter-group">
                    <label>Năm</label>
                    <select @bind="SelectedYear" class="form-control">
                        @foreach (var y in Years)
                        {
                            <option value="@y">@y</option>
                        }
                    </select>
                </div>
            }

            <button class="btn-search ms-2" @onclick="ApplyFilter">
                <i class="fas fa-filter"></i>
                Áp dụng
            </button>
        </div>

        <!-- Biểu đồ -->
        <div class="chart-section">
            <h3 class="chart-title">Doanh thu theo @(SelectedMode == "Month" ? "Ngày" : "Tháng")</h3>
            <!-- Replaced placeholder with canvas for Chart.js bar chart -->
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-container">
            <!-- Revenue Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Tổng doanh thu</span>
                    <div class="kpi-icon revenue">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="kpi-value">₫ @TotalRevenue</div>
            </div>

            <!-- Cost Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Tổng vốn nhập hàng</span>
                    <div class="kpi-icon cost">
                        <i class="fas fa-box"></i>
                    </div>
                </div>
                <div class="kpi-value">₫ @TotalCapital</div>
            </div>

            <!-- Profit Card -->
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Tổng lãi</span>
                    <div class="kpi-icon profit">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="kpi-value">₫ @TotalProfit</div>
            </div>
        </div>

    </div>
</div>
