@page "/thanhtoan"
@using Components.Layout.Client;
@using BlazorStoreManagementWebApp.Components.Forms.Client;
@layout MainLayout

<div class="container-checkout">
    <!-- Left Section -->
    <div class="payment-info">
        <h1 class="section-title">THÔNG TIN THANH TOÁN</h1>

        <form id="checkoutForm">
            <div class="form-group">
                <label class="form-label">Họ và tên người nhận <span class="required">*</span></label>
                <input type="text" class="form-input" @bind="Client.Name" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Số điện thoại <span class="required">*</span></label>
                    <input type="tel" class="form-input" @bind="Client.Phone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Địa chỉ email <span class="required">*</span></label>
                    <input type="email" class="form-input" @bind="Client.Email" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Địa chỉ tài khoản</label>
                <input type="text" class="form-input"
                       @bind="Client.Address" required>
            </div>

            <!-- Moved coupon button and reward points to left section below confirm button -->
            <div class="action-section">
                <button type="button" class="modal-trigger" @onclick="() => DiscountModalRef.OpenModal()">
                    🎟️ Chọn mã giảm giá
                </button>

                <div class="reward-points">
                    <div class="reward-checkbox">
                        <input type="checkbox" id="useRewardPoints" 
                            @onchange="@(e =>
                            {
                                UseRewardPoints = (bool)e.Value;
                                ToggleRewardPoints();
                            })"/>
                        <label for="useRewardPoints">
                            Sử dụng <span class="reward-value">@Client.RewardPoints điểm thưởng</span> (= (@Client.RewardPoints).ToString("N0")đ)
                        </label>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Right Section -->
    <div class="order-summary">
        <h2 class="summary-title">ĐƠN HÀNG CỦA BẠN</h2>

        <div class="products-header">
            <span>SẢN PHẨM</span>
            <span>TẠM TÍNH</span>
        </div>

        <div class="products-list">
            @if (Cart.Any())
            {
                @foreach (var item in Cart)
                {
                    <div class="product-item">
                        <span class="product-name">@item.ProductName</span>
                        <span class="product-quantity"> x @item.Quantity</span>
                        <span class="product-price">
                            @((item.Price * item.Quantity).ToString("N0"))đ
                        </span>
                    </div>
                }
            }
        </div>

        <div class="divider"></div>

        <div class="summary-row">
            <span class="summary-label">Tạm tính</span>
            <span class="summary-value" id="subtotalValue">@Subtotal.ToString("N0")đ</span>
        </div>

        @if (SelectedPromo != null)
        {
            <div class="summary-row discount-row">
                <span class="summary-label">
                    Mã giảm giá (@SelectedPromo.PromoCode)
                </span>
                <span class="summary-value text-danger">
                    -@DiscountAmount.ToString("N0")đ
                </span>
            </div>
        }

        @if (UseRewardPoints && RewardDiscountAmount > 0)
        {
            <div class="summary-row discount-row">
                <span class="summary-label">
                    Điểm thưởng sử dụng
                </span>
                <span class="summary-value text-danger">
                    -@RewardDiscountAmount.ToString("N0")đ
                </span>
            </div>
        }

        <!-- Made total row more prominent with larger, bold text -->
        <div class="summary-row total-row">
            <span class="summary-label">Tổng tiền</span>
            <span class="summary-value" id="totalValue">@Total.ToString("N0")đ</span>
        </div>

        <!-- Payment methods -->
        <div class="payment-methods">
            <div class="payment-method  
                 @(SelectedPaymentMethod == "cash" ? "selected" : "")"
                 @onclick="@(() => SelectPayment("cash"))">
                <input type="radio" id="bankTransfer" name="payment" value="bank" checked>
                <label for="bankTransfer">Chuyển khoản ngân hàng</label>
            </div>

            <div class="payment-method
                 @(SelectedPaymentMethod == "e-wallet" ? "selected" : "")"
                 @onclick="@(() => SelectPayment("e-wallet"))">
                <input type="radio" id="momo" name="payment" value="momo">
                <label for="momo">Ví điện tử Momo</label>
            </div>

            <div class="payment-method
                 @(SelectedPaymentMethod == "bank_transfer" ? "selected" : "")"
                 @onclick="@(() => SelectPayment("bank_transfer"))">
                <input type="radio" id="cod" name="payment" value="cod">
                <label for="cod">Trả tiền mặt khi nhận hàng</label>
            </div>
        </div>

        <button class="order-btn" @onclick="Checkout">ĐẶT HÀNG</button>
    </div>
</div>

<DiscountModal @ref="DiscountModalRef" Subtotal="Subtotal" OnSelected="ApplyDiscount"></DiscountModal>