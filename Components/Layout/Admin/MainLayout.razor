@inherits LayoutComponentBase
@implements IDisposable
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage
@inject NavigationManager Navigation

<HeadContent>
	<link rel="stylesheet" href="css/admin.css" />
    <link rel="stylesheet" href="css/toast.css" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/gh/HuongLamCoder/font-awesome-pro-6.5.2/fontawesome-pro-6.5.2-web/css/all.min.css"
		  rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
	@* <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> *@
</HeadContent>

<Navbar />
<div class="admin-container">
	
	<Sidebar />

	<main class="main-content">
		@Body
	</main>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckAuthentication();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await CheckAuthentication();
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var adminId = await SessionStorage.GetItemAsync<int>("adminId");

            // Nếu không có adminId và không phải login page -> redirect về login
            if (adminId <= 0 && !Navigation.Uri.Contains("/admin/dangnhap"))
            {
                Navigation.NavigateTo("/admin/dangnhap", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking authentication: {ex.Message}");
        }
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}