@using BlazorStoreManagementWebApp.Services.Interfaces
@using BlazorStoreManagementWebApp.Components.Forms.Admin
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage
@inject NavigationManager Navigation
@inject IJSRuntime JS

<nav class="custom-navbar">
    <div class="navbar-content">
        <h1 class="navbar-title">
            <i class="fas fa-store"></i>
            <span>Quản lý Cửa hàng bán lẻ</span>
        </h1>

        <div class="user-profile-dropdown">
            <button class="user-profile-btn" type="button">
                <span class="user-name">@FullName</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="user-dropdown-menu">
                <button class="dropdown-item" @onclick="OpenThongTinCaNhan" type="button">
                    <i class="fas fa-user"></i> Thông tin cá nhân
                </button>
                <button class="dropdown-item" @onclick="Logout" type="button">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </div>
    </div>
</nav>

<ThongTinCaNhanForm @ref="thongTinCaNhanForm" OnSaved="OnProfileUpdated" />

@code {
    private string FullName = "Admin User";
    private ThongTinCaNhanForm? thongTinCaNhanForm;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var name = await SessionStorage.GetItemAsync<string>("adminName");
                if (!string.IsNullOrEmpty(name))
                {
                    FullName = name;
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Lỗi load tên: {ex.Message}");
            }
        }
    }

    private async Task OpenThongTinCaNhan()
    {
        if (thongTinCaNhanForm != null)
        {
            await thongTinCaNhanForm.OpenModal();
        }
        else
        {
            await InvokeAsync(StateHasChanged);
            await Task.Delay(100);
            if (thongTinCaNhanForm != null)
                await thongTinCaNhanForm.OpenModal();
        }
    }

    private async Task OnProfileUpdated()
    {
        try
        {
            var name = await SessionStorage.GetItemAsync<string>("adminName");
            if (!string.IsNullOrEmpty(name))
            {
                FullName = name;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi refresh tên: {ex.Message}");
        }
    }

    private async Task Logout()
    {
        await SessionStorage.RemoveItemAsync("adminId");
        await SessionStorage.RemoveItemAsync("adminName");
        await SessionStorage.RemoveItemAsync("adminRole");
        Navigation.NavigateTo("/admin/dangnhap", forceLoad: true);
    }
}